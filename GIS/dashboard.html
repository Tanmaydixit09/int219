<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgriTrack Pro - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <style>
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideIn {
            from { transform: translateX(-100%); }
            to { transform: translateX(0); }
        }
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }
        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Base Styles */
        body {
            font-family: 'Montserrat', sans-serif;
            background: linear-gradient(135deg, #F3F4F6 0%, #E8F5E9 100%);
            min-height: 100vh;
        }
        .dark body {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: #ffffff;
        }

        /* Typography */
        .heading-primary {
            font-family: 'Playfair Display', serif;
            font-weight: 700;
            letter-spacing: 0.5px;
            color: #1B5E20;
        }
        .dark .heading-primary {
            color: #4CAF50;
        }
        .heading-secondary {
            font-family: 'Playfair Display', serif;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        /* Sidebar */
        .sidebar {
            background: linear-gradient(180deg, #2E7D32 0%, #1B5E20 100%);
            animation: slideIn 0.5s ease-out forwards;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
        }
        .dark .sidebar {
            background: linear-gradient(180deg, #1a1a1a 0%, #2d2d2d 100%);
            border-right: 1px solid rgba(76, 175, 80, 0.2);
            color: rgba(255, 255, 255, 0.9);
        }

        /* Logo Section */
        .logo-section {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .dark .logo-section {
            border-bottom: 1px solid rgba(76, 175, 80, 0.2);
        }

        /* Navigation Links */
        .nav-link {
            font-family: 'Montserrat', sans-serif;
            transition: all 0.3s ease;
            border-radius: 0.5rem;
            margin: 0.25rem 0;
            color: rgba(255, 255, 255, 0.9);
        }
        .dark .nav-link {
            color: rgba(255, 255, 255, 0.8);
        }
        .nav-link:hover, .nav-link.active {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(0.5rem);
            color: #ffffff;
        }
        .dark .nav-link:hover, .dark .nav-link.active {
            background: rgba(76, 175, 80, 0.1);
            color: #4CAF50;
        }
        .nav-link i {
            color: rgba(255, 255, 255, 0.9);
        }
        .dark .nav-link i {
            color: rgba(255, 255, 255, 0.8);
        }
        .nav-link:hover i, .nav-link.active i {
            color: #ffffff;
        }
        .dark .nav-link:hover i, .dark .nav-link.active i {
            color: #4CAF50;
        }

        /* User Profile Section */
        .user-profile {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .dark .user-profile {
            border-bottom: 1px solid rgba(76, 175, 80, 0.2);
        }
        .user-avatar {
            background: rgba(255, 255, 255, 0.1);
        }
        .dark .user-avatar {
            background: rgba(76, 175, 80, 0.1);
        }
        .user-avatar i {
            color: rgba(255, 255, 255, 0.9);
        }
        .dark .user-avatar i {
            color: rgba(255, 255, 255, 0.8);
        }
        .user-name {
            color: rgba(255, 255, 255, 0.9);
        }
        .dark .user-name {
            color: rgba(255, 255, 255, 0.8);
        }
        .user-role {
            color: rgba(255, 255, 255, 0.6);
        }
        .dark .user-role {
            color: rgba(255, 255, 255, 0.5);
        }

        /* Logout Button */
        .logout-btn {
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        .dark .logout-btn {
            border-top: 1px solid rgba(76, 175, 80, 0.2);
        }
        .logout-btn button {
            color: rgba(255, 255, 255, 0.9);
        }
        .dark .logout-btn button {
            color: rgba(255, 255, 255, 0.8);
        }
        .logout-btn button:hover {
            color: #ffffff;
        }
        .dark .logout-btn button:hover {
            color: #4CAF50;
        }
        .logout-btn i {
            color: rgba(255, 255, 255, 0.9);
        }
        .dark .logout-btn i {
            color: rgba(255, 255, 255, 0.8);
        }
        .logout-btn button:hover i {
            color: #ffffff;
        }
        .dark .logout-btn button:hover i {
            color: #4CAF50;
        }

        /* Cards */
        .stat-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 1rem;
            border: 1px solid rgba(46, 125, 50, 0.2);
            transition: all 0.3s ease;
            animation: fadeIn 0.5s ease-out forwards;
        }
        .dark .stat-card {
            background: rgba(45, 45, 45, 0.9);
            border: 1px solid rgba(76, 175, 80, 0.2);
        }
        .stat-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        .dark .stat-card:hover {
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }

        /* Chart Container */
        .chart-container {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 1rem;
            border: 1px solid rgba(46, 125, 50, 0.2);
            padding: 1.5rem;
            animation: fadeIn 0.5s ease-out forwards;
        }
        .dark .chart-container {
            background: rgba(45, 45, 45, 0.9);
            border: 1px solid rgba(76, 175, 80, 0.2);
        }

        /* Status Badges */
        .status-badge {
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
        }
        .status-growing {
            background: rgba(46, 125, 50, 0.1);
            color: #2E7D32;
        }
        .dark .status-growing {
            background: rgba(76, 175, 80, 0.1);
            color: #4CAF50;
        }
        .status-harvesting {
            background: rgba(251, 191, 36, 0.1);
            color: #D97706;
        }
        .dark .status-harvesting {
            background: rgba(251, 191, 36, 0.1);
            color: #FBBF24;
        }
        .status-ready {
            background: rgba(239, 68, 68, 0.1);
            color: #DC2626;
        }
        .dark .status-ready {
            background: rgba(239, 68, 68, 0.1);
            color: #EF4444;
        }

        /* Buttons */
        .btn-primary {
            background: #2E7D32;
            color: white;
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            letter-spacing: 1px;
            text-transform: uppercase;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: all 0.3s ease;
        }
        .dark .btn-primary {
            background: #4CAF50;
        }
        .btn-primary:hover {
            background: #1B5E20;
            transform: translateY(-2px);
        }
        .dark .btn-primary:hover {
            background: #2E7D32;
        }

        /* Theme Toggle */
        .theme-toggle {
            position: fixed;
            top: 1.5rem;
            right: 1.5rem;
            z-index: 50;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 9999px;
            padding: 0.75rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid rgba(46, 125, 50, 0.3);
            cursor: pointer;
        }
        .dark .theme-toggle {
            background: rgba(0, 0, 0, 0.95);
            border-color: rgba(76, 175, 80, 0.3);
        }
        .theme-toggle:hover {
            transform: scale(1.1) rotate(15deg);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }

        /* Crop Cards */
        .crop-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 1rem;
            border: 1px solid rgba(46, 125, 50, 0.2);
            transition: all 0.3s ease;
            animation: fadeIn 0.5s ease-out forwards;
        }
        .dark .crop-card {
            background: rgba(45, 45, 45, 0.9);
            border: 1px solid rgba(76, 175, 80, 0.2);
        }
        .crop-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        .dark .crop-card:hover {
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }

        /* Map Container */
        .map-container {
            border-radius: 1rem;
            overflow: hidden;
            border: 1px solid rgba(46, 125, 50, 0.2);
            animation: fadeIn 0.5s ease-out forwards;
        }
        .dark .map-container {
            border: 1px solid rgba(76, 175, 80, 0.2);
        }

        /* Modal */
        .modal {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 1rem;
            border: 1px solid rgba(46, 125, 50, 0.2);
            animation: fadeIn 0.3s ease-out forwards;
        }
        .dark .modal {
            background: rgba(45, 45, 45, 0.95);
            border: 1px solid rgba(76, 175, 80, 0.2);
        }

        /* Form Elements */
        .form-input {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(46, 125, 50, 0.2);
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            transition: all 0.3s ease;
        }
        .dark .form-input {
            background: rgba(45, 45, 45, 0.9);
            border: 1px solid rgba(76, 175, 80, 0.2);
            color: white;
        }
        .form-input:focus {
            border-color: #2E7D32;
            box-shadow: 0 0 0 2px rgba(46, 125, 50, 0.2);
        }
        .dark .form-input:focus {
            border-color: #4CAF50;
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
        }

        /* Reset and simplify modal styles */
        #welcomeModal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.75);
            display: none;
            z-index: 9999;
            overflow-y: auto;
            padding: 2rem 1rem;
        }

        #welcomeModal.visible {
            display: block;
        }

        .welcome-modal {
            background: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            width: 100%;
            max-width: 720px;
            margin: 0 auto;
            position: relative;
            transform: translateY(20px);
            opacity: 0;
            transition: all 0.3s ease;
        }

        .dark .welcome-modal {
            background: #1f2937;
        }

        .welcome-modal.visible {
            transform: translateY(0);
            opacity: 1;
        }

        .welcome-header {
            background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);
            padding: 2rem;
            border-radius: 1rem 1rem 0 0;
            text-align: center;
        }

        .dark .welcome-header {
            background: linear-gradient(135deg, #2E7D32 0%, #1B5E20 100%);
        }

        .welcome-title {
            color: #ffffff;
            font-size: 2.25rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            font-family: 'Playfair Display', serif;
        }

        .welcome-subtitle {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.1rem;
            line-height: 1.5;
        }

        .welcome-form {
            padding: 2rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .form-group {
            margin: 0;
        }

        .form-group.full-width {
            grid-column: span 2;
        }

        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #000000;
        }

        .dark .form-label {
            color: #f3f4f6;
        }

        .welcome-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #d1d5db;
            border-radius: 0.5rem;
            background: #ffffff;
            color: #000000;
            transition: all 0.2s ease;
        }

        .welcome-input::placeholder {
            color: #4b5563;
        }

        .dark .welcome-input::placeholder {
            color: #9ca3af;
        }

        .dark .welcome-input {
            background: #374151;
            border-color: #4b5563;
            color: #f3f4f6;
        }

        .welcome-btn.secondary {
            background: transparent;
            border: 2px solid #4CAF50;
            color: #000000;
        }

        .dark .welcome-btn.secondary {
            color: #4CAF50;
        }

        .welcome-btn-group {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid #e5e7eb;
        }

        .dark .welcome-btn-group {
            border-top-color: #4b5563;
        }

        .welcome-btn {
            flex: 1;
            padding: 0.875rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .welcome-btn.primary {
            background: #4CAF50;
            color: #ffffff;
            border: none;
        }

        .welcome-btn.primary:hover {
            background: #2E7D32;
        }

        @media (max-width: 640px) {
            #welcomeModal {
                padding: 1rem;
            }

            .welcome-modal {
                margin: 0 auto;
            }

            .welcome-header {
                padding: 1.5rem;
            }

            .welcome-title {
                font-size: 1.75rem;
            }

            .welcome-subtitle {
                font-size: 1rem;
            }

            .welcome-form {
                padding: 1.5rem;
            }

            .form-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .form-group.full-width {
                grid-column: span 1;
            }

            .welcome-btn-group {
                flex-direction: column;
            }

            .welcome-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Main Layout -->
    <div class="flex min-h-screen">
        <!-- Sidebar -->
        <div class="sidebar w-64 fixed h-full">
            <div class="flex flex-col h-full">
                <!-- Logo -->
                <div class="logo-section p-6">
                    <img src="logo.svg" alt="AgriTrack Pro" class="h-12">
                </div>

                <!-- User Profile -->
                <div class="user-profile p-4">
                    <div class="flex items-center space-x-4">
                        <div class="user-avatar w-12 h-12 rounded-full flex items-center justify-center">
                            <i class="fas fa-user text-xl"></i>
                        </div>
                <div>
                            <h3 class="user-name text-lg font-semibold" id="userName">Loading...</h3>
                            <p class="user-role text-sm">Farmer</p>
                        </div>
                        </div>
                    </div>

                <!-- Navigation -->
                <nav class="flex-1 p-4 space-y-2">
                    <a href="index.html" class="nav-link flex items-center space-x-3 px-4 py-3 rounded-lg transition-all duration-300">
                        <i class="fas fa-home text-lg"></i>
                        <span>Home</span>
                    </a>
                    <a href="#" class="nav-link flex items-center space-x-3 px-4 py-3 rounded-lg transition-all duration-300">
                        <i class="fas fa-chart-line text-lg"></i>
                        <span>Dashboard</span>
                    </a>
                    <a href="my_crops.html" class="nav-link flex items-center space-x-3 px-4 py-3 rounded-lg transition-all duration-300">
                        <i class="fas fa-leaf text-lg"></i>
                        <span>My Crops</span>
                    </a>
                    <a href="field_map.html" class="nav-link flex items-center space-x-3 px-4 py-3 rounded-lg transition-all duration-300">
                        <i class="fas fa-map-marked-alt text-lg"></i>
                        <span>Field Map</span>
                    </a>
                    <a href="settings.html" class="nav-link flex items-center space-x-3 px-4 py-3 rounded-lg transition-all duration-300">
                        <i class="fas fa-cog text-lg"></i>
                        <span>Settings</span>
                    </a>
                </nav>

                <!-- Logout Button -->
                <div class="logout-btn p-6">
                    <button onclick="logout()" class="nav-link w-full flex items-center p-3 space-x-3">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Logout</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 ml-64 p-8">
            <!-- Header -->
            <div class="mb-8">
                <h1 class="heading-primary text-3xl mb-2">Welcome Back!</h1>
                <p class="text-blue-600 bg-black rounded-3xl px-4 py-2 w-fit dark:text-gray-300">Here's what's happening with your crops today</p>
                        </div>

            <!-- Stats Grid -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="stat-card p-6">
                    <div class="flex items-center justify-between">
                            <div>
                            <p class="text-black dark:text-gray-400  text-sm">Total Crops</p>
                            <h3 id="total-crops" class="text-2xl font-bold text-gray-900 dark:text-blue-600 mt-1">0</h3>
                            </div>
                        <div class="w-12 h-12 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center">
                            <i class="fas fa-seedling text-green-600 dark:text-green-400 text-xl"></i>
                        </div>
                    </div>
                </div>
                <div class="stat-card p-6">
                    <div class="flex items-center justify-between">
                            <div>
                            <p class="text-gray-600 dark:text-gray-400 text-sm">Active Fields</p>
                            <h3 id="active-fields" class="text-2xl font-bold text-gray-900 dark:text-blue-600 mt-1">0</h3>
                            </div>
                        <div class="w-12 h-12 rounded-full bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center">
                            <i class="fas fa-map-marked-alt text-blue-600 dark:text-blue-400 text-xl"></i>
                        </div>
                    </div>
                </div>
                <div class="stat-card p-6">
                    <div class="flex items-center justify-between">
                            <div>
                            <p class="text-gray-600 dark:text-gray-400 text-sm">Harvest Ready</p>
                            <h3 id="harvest-ready" class="text-2xl font-bold text-gray-900 dark:text-yellow-400 mt-1">0</h3>
                            </div>
                        <div class="w-12 h-12 rounded-full bg-yellow-100 dark:bg-yellow-900/30 flex items-center justify-center">
                            <i class="fas fa-check-circle text-yellow-600 dark:text-yellow-400 text-xl"></i>
                        </div>
                    </div>
                </div>
                <div class="stat-card p-6">
                    <div class="flex items-center justify-between">
                            <div>
                            <p class="text-gray-600 dark:text-gray-400 text-sm">Weather</p>
                            <h3 id="weather" class="text-2xl font-bold text-gray-900 dark:text-purple-600 mt-1">Loading...</h3>
                            </div>
                        <div class="w-12 h-12 rounded-full bg-purple-100 dark:bg-purple-900/30 flex items-center justify-center">
                            <i class="fas fa-cloud-sun text-purple-600 dark:text-purple-400 text-xl"></i>
                        </div>
                            </div>
                            </div>
            </div>

            <!-- Charts and Map Section -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <div class="chart-container">
                    <h2 class="heading-secondary text-xl mb-4">Crop Progress</h2>
                    <div class="h-64">
                        <canvas id="cropProgressChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <h2 class="heading-secondary text-xl mb-4">Field Map</h2>
                    <div id="map" class="h-64 rounded-lg"></div>
                        </div>
                    </div>

            <!-- Crops Section -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="chart-container">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="heading-secondary text-xl">My Crops</h2>
                        <button onclick="showAddCropModal()" class="btn-primary">
                            <i class="fas fa-plus mr-2"></i>Add New Crop
                        </button>
                        </div>
                    <div id="cropsContainer" class="space-y-4">
                        <!-- Crop cards will be added here -->
                    </div>
                </div>
                <div class="chart-container">
                    <h2 class="heading-secondary text-xl mb-4">Recent Activity</h2>
                    <div id="recentActivity" class="space-y-4">
                        <!-- Activity items will be added here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Theme Toggle -->
    <button id="themeToggle" class="theme-toggle">
        <i class="fas fa-sun text-yellow-500 dark:hidden"></i>
        <i class="fas fa-moon text-blue-400 hidden dark:block"></i>
    </button>

    <!-- Add Crop Modal -->
    <div id="addCropModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg p-8 w-full max-w-2xl">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold text-gray-900 dark:text-white">Add New Crop</h2>
                <button onclick="hideAddCropModal()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="cropForm" onsubmit="handleCropFormSubmit(event)" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Crop Type</label>
                        <select id="cropType" required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                            <option value="">Select Crop Type</option>
                            <option value="Wheat">Wheat</option>
                            <option value="Rice">Rice</option>
                            <option value="Corn">Corn</option>
                            <option value="Soybean">Soybean</option>
                            <option value="Cotton">Cotton</option>
                            <option value="Potato">Potato</option>
                            <option value="Tomato">Tomato</option>
                            <option value="Other">Other</option>
                        </select>
                            </div>
                            <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Field Size (acres)</label>
                        <div class="relative">
                            <input type="number" id="fieldSize" required min="0.1" step="0.1"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                            <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                <span class="text-gray-500 dark:text-gray-400">acres</span>
                            </div>
                        </div>
                            </div>
                            <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Planting Date</label>
                        <input type="date" id="plantingDate" required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                            </div>
                            <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Expected Harvest Date</label>
                        <input type="date" id="harvestDate" required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                            </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Location</label>
                        <div class="relative">
                            <input type="text" id="location" required
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                                placeholder="Enter field location">
                            <div class="absolute inset-y-0 right-0 flex items-center pr-3">
                                <button type="button" onclick="getCurrentLocation()" class="text-green-600 hover:text-green-700 dark:text-green-400 dark:hover:text-green-300">
                                    <i class="fas fa-map-marker-alt"></i>
                                </button>
                        </div>
                            </div>
                            </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Notes</label>
                        <textarea id="notes" rows="3"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                            placeholder="Add any additional notes about the crop..."></textarea>
                        </div>
                    </div>
                <div class="flex justify-end space-x-4 mt-6">
                    <button type="button" onclick="hideAddCropModal()"
                        class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700">
                        Cancel
                    </button>
                    <button type="submit"
                        class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                        Save Crop
                    </button>
                </div>
            </form>
                </div>
            </div>

    <!-- Welcome Modal -->
    <div id="welcomeModal">
        <div class="welcome-modal" id="welcomeModalContent">
            <div class="welcome-header">
                <h2 class="welcome-title">Welcome to AgriTrack Pro!</h2>
                <p class="welcome-subtitle">Let's get started by adding your first crop to begin your farming journey. Track, manage, and optimize your agricultural operations with ease.</p>
                </div>
            <div class="welcome-form">
                <form id="welcomeCropForm" onsubmit="handleWelcomeCropSubmit(event)">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label" for="welcomeCropType">
                                <i class="fas fa-seedling mr-2 text-green-600"></i>
                                Crop Type
                            </label>
                            <select id="welcomeCropType" required class="welcome-input">
                                <option value="">Select Crop Type</option>
                                <option value="Wheat">Wheat</option>
                                <option value="Rice">Rice</option>
                                <option value="Corn">Corn</option>
                                <option value="Soybean">Soybean</option>
                                <option value="Cotton">Cotton</option>
                                <option value="Potato">Potato</option>
                                <option value="Tomato">Tomato</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="welcomeFieldSize">
                                <i class="fas fa-ruler-combined mr-2 text-green-600"></i>
                                Field Size
                            </label>
                            <div class="relative">
                                <input type="number" id="welcomeFieldSize" required min="0.1" step="0.1" 
                                    class="welcome-input" placeholder="Enter field size">
                                <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                    <span class="text-black dark:text-gray-400">acres</span>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="welcomePlantingDate">
                                <i class="fas fa-calendar-alt mr-2 text-green-600"></i>
                                Planting Date
                            </label>
                            <input type="date" id="welcomePlantingDate" required class="welcome-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="welcomeHarvestDate">
                                <i class="fas fa-clock mr-2 text-green-600"></i>
                                Expected Harvest Date
                            </label>
                            <input type="date" id="welcomeHarvestDate" required class="welcome-input">
                        </div>
                        <div class="form-group full-width">
                            <label class="form-label" for="welcomeLocation">
                                <i class="fas fa-map-marker-alt mr-2 text-green-600"></i>
                                Location
                            </label>
                            <div class="relative">
                                <input type="text" id="welcomeLocation" required class="welcome-input pr-10" 
                                    placeholder="Enter your field location">
                                <button type="button" onclick="getCurrentLocation('welcomeLocation')" 
                                    class="absolute right-3 top-1/2 transform -translate-y-1/2 text-green-600 hover:text-green-700 dark:text-green-400 dark:hover:text-green-300">
                                    <i class="fas fa-crosshairs text-lg"></i>
                                </button>
                            </div>
                        </div>
                        <div class="form-group full-width">
                            <label class="form-label" for="welcomeNotes">
                                <i class="fas fa-sticky-note mr-2 text-green-600"></i>
                                Notes
                            </label>
                            <textarea id="welcomeNotes" rows="4" class="welcome-input"
                                placeholder="Add any additional notes about your crop (optional)..."></textarea>
                        </div>
                    </div>
                    <div class="welcome-btn-group">
                        <button type="button" onclick="hideWelcomeModal()" class="welcome-btn secondary">
                            Cancel
                        </button>
                        <button type="submit" class="welcome-btn primary">
                            Start Your Farming Journey
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let mapInstance = null;
        let chartInstance = null;
        let sessionCheckInterval = null;
        let isFirstTimeUser = true;

        // Function to check session
        async function checkSession() {
            try {
                console.log('Checking session...');
                const userData = JSON.parse(sessionStorage.getItem('user') || localStorage.getItem('user'));
                console.log('User data:', userData);
                
                if (!userData || !userData.id) {
                    console.log('No user data or ID found');
                    return false;
                }

                const response = await fetch(`api/check_session.php?user_id=${userData.id}`);
                const data = await response.json();
                console.log('Session check response:', data);
                
                return data.status === 'success';
            } catch (error) {
                console.error('Session check error:', error);
                return false;
            }
        }

        // Function to check if user has any crops
        async function checkUserCrops() {
            try {
                const userData = JSON.parse(sessionStorage.getItem('user') || localStorage.getItem('user'));
                if (!userData || !userData.id) {
                    console.error('No user data found');
                    return;
                }

                console.log('Checking crops for user:', userData.id);
                const response = await fetch(`api/get_crops.php?user_id=${userData.id}`);
                const data = await response.json();
                console.log('Crops response:', data);
                
                if (data.status === 'success' && (!data.data || data.data.length === 0)) {
                    console.log('No crops found, showing welcome modal');
                    setTimeout(() => {
                        showWelcomeModal();
                    }, 1000); // Add small delay to ensure DOM is ready
                }
            } catch (error) {
                console.error('Error checking user crops:', error);
            }
        }

        // Function to show welcome modal
        function showWelcomeModal() {
            const modal = document.getElementById('welcomeModal');
            const modalContent = document.getElementById('welcomeModalContent');
            
            document.body.style.overflow = 'hidden';
            modal.classList.add('visible');
            
            setTimeout(() => {
                modalContent.classList.add('visible');
                document.getElementById('welcomeCropType').focus();
            }, 50);
        }

        // Function to hide welcome modal
        function hideWelcomeModal() {
            const modal = document.getElementById('welcomeModal');
            const modalContent = document.getElementById('welcomeModalContent');
            
            modalContent.classList.remove('visible');
            
            setTimeout(() => {
                modal.classList.remove('visible');
                document.body.style.overflow = '';
            }, 300);
        }

        // Function to handle welcome form submission
        async function handleWelcomeCropSubmit(event) {
            event.preventDefault();
            console.log('Handling welcome form submission');
            
            const formData = {
                user_id: JSON.parse(localStorage.getItem('user')).id,
                crop_type: document.getElementById('welcomeCropType').value,
                field_size: document.getElementById('welcomeFieldSize').value,
                planting_date: document.getElementById('welcomePlantingDate').value,
                expected_harvest_date: document.getElementById('welcomeHarvestDate').value,
                location: document.getElementById('welcomeLocation').value,
                notes: document.getElementById('welcomeNotes').value
            };

            try {
                const response = await fetch('api/save_crop.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();
                console.log('Welcome form submission response:', data);
                
                if (data.status === 'success') {
                    hideWelcomeModal();
                    addCropToDashboard(data.data);
                    updateDashboardStats();
                    addToRecentActivity(data.data);
                    updateMap(data.data);
                    showSuccessMessage('Your first crop has been added successfully!');
                } else {
                    alert(data.message || 'Error saving crop data');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while saving crop data');
            }
        }

        // Theme handling
        function initializeTheme() {
            // Get theme from localStorage or default to light
            const theme = localStorage.getItem('theme') || 'light';
            const html = document.documentElement;
            
            // Apply theme
            if (theme === 'dark') {
                html.classList.add('dark');
            } else {
                html.classList.remove('dark');
            }
            
            // Update theme toggle button
            const themeToggle = document.getElementById('themeToggle');
            if (themeToggle) {
                themeToggle.addEventListener('click', () => {
                    // Toggle dark class on html element
                    html.classList.toggle('dark');
                    
                    // Update localStorage
                    const newTheme = html.classList.contains('dark') ? 'dark' : 'light';
                    localStorage.setItem('theme', newTheme);
                    
                    // Update theme toggle icons
                    const sunIcon = themeToggle.querySelector('.fa-sun');
                    const moonIcon = themeToggle.querySelector('.fa-moon');
                    
                    if (newTheme === 'dark') {
                        sunIcon.classList.add('hidden');
                        moonIcon.classList.remove('hidden');
                        // Update sidebar colors for dark theme
                        document.querySelector('.sidebar').style.background = 'linear-gradient(180deg, #1a1a1a 0%, #2d2d2d 100%)';
                        document.querySelector('.sidebar').style.borderRight = '1px solid rgba(76, 175, 80, 0.2)';
                    } else {
                        sunIcon.classList.remove('hidden');
                        moonIcon.classList.add('hidden');
                        // Update sidebar colors for light theme
                        document.querySelector('.sidebar').style.background = 'linear-gradient(180deg, #2E7D32 0%, #1B5E20 100%)';
                        document.querySelector('.sidebar').style.borderRight = '1px solid rgba(255, 255, 255, 0.1)';
                    }

                    // Update all nav links
                    document.querySelectorAll('.nav-link').forEach(link => {
                        if (newTheme === 'dark') {
                            link.style.color = 'rgba(255, 255, 255, 0.8)';
                            link.querySelector('i').style.color = 'rgba(255, 255, 255, 0.8)';
                        } else {
                            link.style.color = 'rgba(255, 255, 255, 0.9)';
                            link.querySelector('i').style.color = 'rgba(255, 255, 255, 0.9)';
                        }
                    });

                    // Update user profile section
                    const userProfile = document.querySelector('.user-profile');
                    if (userProfile) {
                        if (newTheme === 'dark') {
                            userProfile.style.borderBottom = '1px solid rgba(76, 175, 80, 0.2)';
                            userProfile.querySelector('.user-avatar').style.background = 'rgba(76, 175, 80, 0.1)';
                            userProfile.querySelector('.user-name').style.color = 'rgba(255, 255, 255, 0.8)';
                            userProfile.querySelector('.user-role').style.color = 'rgba(255, 255, 255, 0.5)';
                        } else {
                            userProfile.style.borderBottom = '1px solid rgba(255, 255, 255, 0.1)';
                            userProfile.querySelector('.user-avatar').style.background = 'rgba(255, 255, 255, 0.1)';
                            userProfile.querySelector('.user-name').style.color = 'rgba(255, 255, 255, 0.9)';
                            userProfile.querySelector('.user-role').style.color = 'rgba(255, 255, 255, 0.6)';
                        }
                    }

                    // Update logout button
                    const logoutBtn = document.querySelector('.logout-btn');
                    if (logoutBtn) {
                        if (newTheme === 'dark') {
                            logoutBtn.style.borderTop = '1px solid rgba(76, 175, 80, 0.2)';
                            logoutBtn.querySelector('button').style.color = 'rgba(255, 255, 255, 0.8)';
                            logoutBtn.querySelector('i').style.color = 'rgba(255, 255, 255, 0.8)';
                        } else {
                            logoutBtn.style.borderTop = '1px solid rgba(255, 255, 255, 0.1)';
                            logoutBtn.querySelector('button').style.color = 'rgba(255, 255, 255, 0.9)';
                            logoutBtn.querySelector('i').style.color = 'rgba(255, 255, 255, 0.9)';
                        }
                    }
                });
            }
        }

        // Initialize dashboard
        async function initializeDashboard() {
            try {
                console.log('Initializing dashboard...');
                
                // Initialize theme first
                initializeTheme();
                
                // Check session
                const isValidSession = await checkSession();
                if (!isValidSession) {
                    window.location.href = 'login.html';
                    return;
                }

                // Update user name
                const userData = JSON.parse(sessionStorage.getItem('user') || localStorage.getItem('user'));
                const userNameElement = document.getElementById('userName');
                if (userNameElement) {
                    userNameElement.textContent = userData.email.split('@')[0] || 'User';
                }

                // Initialize components
                initializeChartAndMap();
                await checkUserCrops();
                await loadExistingCrops();
                updateDashboardStats();

                console.log('Dashboard initialization complete');
            } catch (error) {
                console.error('Error initializing dashboard:', error);
                window.location.href = 'login.html';
            }
        }

        // Function to initialize chart and map
        function initializeChartAndMap() {
            // Initialize chart
            const chartElement = document.getElementById('cropProgressChart');
            if (chartElement) {
                const cropProgressCtx = chartElement.getContext('2d');
                chartInstance = new Chart(cropProgressCtx, {
                type: 'line',
                data: {
                        labels: [],
                        datasets: [{
                            label: 'Growth Progress',
                            data: [],
                            borderColor: '#2E7D32',
                            backgroundColor: 'rgba(46, 125, 50, 0.1)',
                            tension: 0.4,
                            fill: true,
                            borderWidth: 2,
                            pointRadius: 4,
                            pointBackgroundColor: '#2E7D32',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2,
                            pointHoverRadius: 6,
                            pointHoverBackgroundColor: '#1B5E20',
                            pointHoverBorderColor: '#ffffff',
                            pointHoverBorderWidth: 2
                        }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: '#ffffff',
                                bodyColor: '#ffffff',
                                borderColor: '#2E7D32',
                                borderWidth: 1,
                                padding: 10,
                                displayColors: false,
                                callbacks: {
                                    label: function(context) {
                                        return `Growth: ${context.parsed.y}%`;
                                    }
                                }
                            }
                        },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.1)',
                                    drawBorder: false
                                },
                            ticks: {
                                    color: '#6B7280',
                                    font: {
                                        family: 'Montserrat',
                                        size: 12
                                    },
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                            },
                            x: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    color: '#6B7280',
                                    font: {
                                        family: 'Montserrat',
                                        size: 12
                                }
                            }
                        }
                    }
                }
            });
            }

            // Initialize map
            const mapElement = document.getElementById('map');
            if (mapElement) {
                mapInstance = L.map('map').setView([51.505, -0.09], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: ' OpenStreetMap contributors'
                }).addTo(mapInstance);
            }
        }

        // Function to update chart with crop data
        function updateChart(crops) {
            if (!chartInstance) return;

            // Filter out crops with invalid dates
            const validCrops = crops.filter(crop => 
                isValidDate(crop.planting_date) && 
                isValidDate(crop.harvest_date || crop.expected_harvest_date)
            );

            // Sort crops by planting date
            const sortedCrops = [...validCrops].sort((a, b) => 
                new Date(a.planting_date) - new Date(b.planting_date)
            );

            // Calculate progress for each crop
            const today = new Date();
            const labels = [];
            const data = [];

            sortedCrops.forEach(crop => {
                const plantingDate = new Date(crop.planting_date);
                const harvestDate = new Date(crop.harvest_date || crop.expected_harvest_date);
                const totalDays = (harvestDate - plantingDate) / (1000 * 60 * 60 * 24);
                const daysPassed = (today - plantingDate) / (1000 * 60 * 60 * 24);
                
                let progress = (daysPassed / totalDays) * 100;
                progress = Math.min(Math.max(progress, 0), 100); // Clamp between 0 and 100

                labels.push(crop.crop_type);
                data.push(Math.round(progress));
            });

            // Update chart data
            chartInstance.data.labels = labels;
            chartInstance.data.datasets[0].data = data;
            chartInstance.update();
        }

        // Update the loadExistingCrops function to include chart update
        async function loadExistingCrops() {
            try {
                const user = JSON.parse(localStorage.getItem('user'));
                if (!user) {
                    window.location.href = 'login.html';
                    return;
                }

                const response = await fetch(`api/get_crops.php?user_id=${user.id}`);
                const data = await response.json();

                if (data.status === 'success' && data.data) {
                    // Clear existing crops
                    document.getElementById('cropsContainer').innerHTML = '';
                    
                    // Add each crop to the dashboard
                    data.data.forEach(crop => {
                        addCropToDashboard(crop);
                    });
                    
                    // Update stats, map, and chart
                    updateDashboardStats();
                    initializeMap(data.data);
                    updateChart(data.data);
                }
            } catch (error) {
                console.error('Error loading crops:', error);
            }
        }

        // Document ready handler
        $(document).ready(function() {
            console.log('Document ready, starting initialization...');
            // Add small delay to ensure all elements are loaded
            setTimeout(() => {
                initializeDashboard();
            }, 500);
        });

        // Function to show the add crop modal
        function showAddCropModal() {
            const modal = document.getElementById('addCropModal');
            modal.classList.remove('hidden');
        }

        // Function to hide the add crop modal
        function hideAddCropModal() {
            const modal = document.getElementById('addCropModal');
            modal.classList.add('hidden');
        }

        // Function to get current location
        async function getCurrentLocation(inputId) {
            try {
                if (!navigator.geolocation) {
                    throw new Error('Geolocation is not supported by your browser');
                }

                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject);
                });

                const { latitude, longitude } = position.coords;
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`);
                const data = await response.json();
                
                const address = data.display_name;
                document.getElementById(inputId).value = address;
                
                if (mapInstance) {
                    mapInstance.setView([latitude, longitude], 13);
                    L.marker([latitude, longitude]).addTo(mapInstance)
                        .bindPopup('Current Location')
                        .openPopup();
                }
            } catch (error) {
                console.error('Error getting location:', error);
                alert('Unable to get your location. Please enter it manually.');
            }
        }

        // Function to handle form submission
        async function handleCropFormSubmit(event) {
            event.preventDefault();
            
            const formData = {
                user_id: JSON.parse(localStorage.getItem('user')).id,
                crop_type: document.getElementById('cropType').value,
                field_size: document.getElementById('fieldSize').value,
                planting_date: document.getElementById('plantingDate').value,
                expected_harvest_date: document.getElementById('harvestDate').value,
                location: document.getElementById('location').value,
                notes: document.getElementById('notes').value
            };

            try {
                const response = await fetch('api/save_crop.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();
                
                if (data.status === 'success') {
                    hideAddCropModal();
                    addCropToDashboard(data.data);
                    updateDashboardStats();
                    addToRecentActivity(data.data);
                    updateMap(data.data);
                    showSuccessMessage('Crop added successfully!');
                    
                    // Reset form
                    document.getElementById('cropForm').reset();
                } else {
                    alert(data.message || 'Error saving crop data');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while saving crop data');
            }
        }

        // Helper function to format date
        function formatDate(dateString) {
            if (!dateString) return 'Not set';
            
            try {
                // Ensure the date string is in a valid format
                const date = new Date(dateString);
                if (isNaN(date.getTime())) {
                    console.error('Invalid date:', dateString);
                    return 'Invalid date';
                }
                
                const options = { 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric'
                };
                return date.toLocaleDateString(undefined, options);
            } catch (error) {
                console.error('Error formatting date:', error);
                return 'Invalid date';
            }
        }

        // Function to validate date string
        function isValidDate(dateString) {
            if (!dateString) return false;
            
            const date = new Date(dateString);
            return !isNaN(date.getTime());
        }

        // Function to add crop to dashboard with improved styling
        function addCropToDashboard(cropData) {
            const cropsContainer = document.getElementById('cropsContainer');
            
            // Validate dates - handle both harvest_date and expected_harvest_date
            const plantingDate = isValidDate(cropData.planting_date) ? formatDate(cropData.planting_date) : 'Not set';
            const harvestDate = isValidDate(cropData.harvest_date || cropData.expected_harvest_date) ? 
                formatDate(cropData.harvest_date || cropData.expected_harvest_date) : 'Not set';
            
            const cropCard = document.createElement('div');
            cropCard.className = 'crop-card bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 hover:shadow-lg transition-all duration-300 mb-4';
            cropCard.setAttribute('data-crop-id', cropData.id);
            cropCard.innerHTML = `
                <div class="flex justify-between items-start mb-4">
                    <h3 class="text-xl font-semibold text-gray-900 dark:text-white">${cropData.crop_type}</h3>
                    <span class="status-badge px-3 py-1 text-sm rounded-full ${getStatusClass(cropData)}">
                        ${getStatusText(cropData)}
                    </span>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Field Size</p>
                        <p class="font-medium text-gray-900 dark:text-white">${cropData.field_size} acres</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Location</p>
                        <p class="font-medium text-gray-900 dark:text-white">${cropData.location}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Planting Date</p>
                        <p class="font-medium text-gray-900 dark:text-white">${plantingDate}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Expected Harvest</p>
                        <p class="font-medium text-gray-900 dark:text-white">${harvestDate}</p>
                    </div>
                </div>
                ${cropData.notes ? `
                    <div class="mt-4">
                        <p class="text-sm text-gray-500 dark:text-gray-400">Notes</p>
                        <p class="text-gray-700 dark:text-gray-300">${cropData.notes}</p>
                    </div>
                ` : ''}
                <div class="mt-4 flex justify-end space-x-2">
                    <button onclick="editCrop(${cropData.id})" class="text-blue-600 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="deleteCrop(${cropData.id})" class="text-red-600 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            
            cropsContainer.insertBefore(cropCard, cropsContainer.firstChild);
        }

        // Helper function to get status class
        function getStatusClass(cropData) {
            const harvestDate = cropData.harvest_date || cropData.expected_harvest_date;
            if (!isValidDate(harvestDate)) {
                return 'bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200';
            }

            const today = new Date();
            const harvestDateObj = new Date(harvestDate);
            const daysUntilHarvest = Math.ceil((harvestDateObj - today) / (1000 * 60 * 60 * 24));
            
            if (daysUntilHarvest <= 0) {
                return 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200';
            } else if (daysUntilHarvest <= 30) {
                return 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200';
            } else {
                return 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200';
            }
        }

        function getStatusText(cropData) {
            const harvestDate = cropData.harvest_date || cropData.expected_harvest_date;
            if (!isValidDate(harvestDate)) {
                return 'Date not set';
            }

            const today = new Date();
            const harvestDateObj = new Date(harvestDate);
            const daysUntilHarvest = Math.ceil((harvestDateObj - today) / (1000 * 60 * 60 * 24));
            
            if (daysUntilHarvest <= 0) {
                return 'Ready for Harvest';
            } else if (daysUntilHarvest <= 30) {
                return 'Harvesting Soon';
            } else {
                return 'Growing';
            }
        }

        // Function to update dashboard stats
        function updateDashboardStats() {
            const crops = document.querySelectorAll('#cropsContainer .crop-card');
            const totalCrops = crops.length;
            const activeFields = totalCrops; // Assuming all fields are active
            const harvestReady = Array.from(crops).filter(crop => {
                const status = crop.querySelector('.status-badge').textContent;
                return status === 'Ready for Harvest';
            }).length;

            // Update stats
            document.getElementById('total-crops').textContent = totalCrops;
            document.getElementById('active-fields').textContent = activeFields;
            document.getElementById('harvest-ready').textContent = harvestReady;

            // Update weather if available
            updateWeather();
        }

        // Function to update weather
        async function updateWeather() {
            try {
                const response = await fetch('api/get_weather.php');
                const data = await response.json();
                
                if (data.status === 'success') {
                    const weatherElement = document.getElementById('weather');
                    if (weatherElement) {
                        weatherElement.innerHTML = `
                            <div class="flex items-center">
                                <i class="fas fa-cloud-sun text-2xl mr-2"></i>
                                <span>${data.temperature}C</span>
                            </div>
                        `;
                    }
                }
            } catch (error) {
                console.error('Error fetching weather:', error);
            }
        }

        // Function to initialize map
        function initializeMap(crops) {
            if (mapInstance) {
                mapInstance.remove();
            }

            mapInstance = L.map('map').setView([51.505, -0.09], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: ' OpenStreetMap contributors'
            }).addTo(mapInstance);

            crops.forEach(crop => {
                const marker = L.marker([51.5, -0.09]).addTo(mapInstance);
                marker.bindPopup(`
                    <div class="p-2">
                        <h3 class="font-bold text-green-600">${crop.crop_type} Field</h3>
                        <p class="text-sm">Size: ${crop.field_size} acres</p>
                        <p class="text-sm">Location: ${crop.location}</p>
                        <p class="text-xs text-gray-500">Planted: ${crop.planting_date}</p>
                    </div>
                `);
            });
        }

        // Function to update map with new crop
        function updateMap(cropData) {
            const marker = L.marker([51.5, -0.09]).addTo(mapInstance);
            marker.bindPopup(`
                <div class="p-2">
                    <h3 class="font-bold text-green-600">${cropData.crop_type} Field</h3>
                    <p class="text-sm">Size: ${cropData.field_size} acres</p>
                    <p class="text-sm">Location: ${cropData.location}</p>
                    <p class="text-xs text-gray-500">Planted: ${cropData.planting_date}</p>
                </div>
            `);
        }

        // Function to add to recent activity
        function addToRecentActivity(cropData) {
            const activityList = document.getElementById('recentActivity');
            const div = document.createElement('div');
            div.className = 'flex items-center space-x-3 p-4 bg-gray-50 rounded-lg';
            div.innerHTML = `
                <i class="fas fa-seedling text-green-500 text-xl"></i>
                <div>
                    <p class="text-gray-800 font-medium">New ${cropData.crop_type} crop added</p>
                    <p class="text-sm text-gray-500">Field Size: ${cropData.field_size} acres | Location: ${cropData.location}</p>
                    <p class="text-xs text-gray-400">Planted: ${cropData.planting_date} | Expected Harvest: ${cropData.expected_harvest_date}</p>
                </div>
            `;
            activityList.insertBefore(div, activityList.firstChild);
        }

        // Function to show success message
        function showSuccessMessage(message) {
            const successMessage = document.createElement('div');
            successMessage.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg transform transition-all duration-300 ease-in-out';
            successMessage.innerHTML = `
                <div class="flex items-center space-x-2">
                    <i class="fas fa-check-circle"></i>
                    <span>${message}</span>
                </div>
            `;
            document.body.appendChild(successMessage);

            setTimeout(() => {
                successMessage.style.opacity = '0';
                successMessage.style.transform = 'translateY(-20px)';
                setTimeout(() => {
                    document.body.removeChild(successMessage);
                }, 300);
            }, 3000);
        }

        // Logout function
        function logout() {
            sessionStorage.removeItem('user');
            localStorage.removeItem('user');
            if (sessionCheckInterval) {
                clearInterval(sessionCheckInterval);
            }
            window.location.href = 'login.html';
        }

        // Close modal when clicking outside
        document.getElementById('welcomeModal').addEventListener('click', function(event) {
            if (event.target === this) {
                hideWelcomeModal();
            }
        });

        // Function to delete crop
        async function deleteCrop(cropId) {
            if (!confirm('Are you sure you want to delete this crop?')) {
                return;
            }

            try {
                // Get user data from localStorage
                const userData = JSON.parse(localStorage.getItem('user'));
                if (!userData || !userData.id) {
                    throw new Error('User not logged in');
                }

                const response = await fetch(`api/delete_crop.php?id=${cropId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-Data': JSON.stringify(userData)
                    }
                });

                const data = await response.json();
                console.log('Delete response:', data);

                if (data.status === 'success') {
                    // Remove the crop card from UI
                    const cropCard = document.querySelector(`[data-crop-id="${cropId}"]`);
                    if (cropCard) {
                        cropCard.remove();
                    }
                    
                    // Update dashboard stats
                    updateDashboardStats();
                    
                    // Add to recent activity
                    const activityList = document.getElementById('recentActivity');
                    const div = document.createElement('div');
                    div.className = 'flex items-center space-x-3 p-4 bg-red-50 dark:bg-red-900/10 rounded-lg';
                    div.innerHTML = `
                        <i class="fas fa-trash text-red-500 text-xl"></i>
                        <div>
                            <p class="text-gray-800 dark:text-gray-200 font-medium">Crop deleted</p>
                            <p class="text-xs text-gray-400">${new Date().toLocaleString()}</p>
                        </div>
                    `;
                    activityList.insertBefore(div, activityList.firstChild);
                    
                    showSuccessMessage('Crop deleted successfully!');
                } else {
                    throw new Error(data.message || 'Error deleting crop');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while deleting the crop: ' + error.message);
            }
        }
    </script>
</body>
</html> 